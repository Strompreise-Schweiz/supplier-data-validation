name: "Reusable: Validate static tariff"

on:
  workflow_call:
    inputs:
      tariff_schema_version:
        description: "Tariff schema version to validate against (e.g. v1, v2)"
        required: true
        default: "v1"
        type: string
      tariff_name:
        description: "Folder name of the tariff (e.g. 'emn-050')"
        required: true
        type: string
      tariff_year:
        description: "Tariff file name (4-digit year, e.g. '2025')"
        required: true
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ajv + formats
        run: npm i -g ajv-cli@5 ajv-formats

      # 1) Check inputs & path
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          if ! [[ "${{ inputs.tariff_name }}" =~ ^[a-z0-9-]{3,}$ ]]; then
            echo "Invalid 'tariff_name': '${{ inputs.tariff_name }}' (expected lowercase letters, digits, hyphens; min length 3)"
            exit 1
          fi

          if ! [[ "${{ inputs.tariff_year }}" =~ ^[0-9]{4}$ ]]; then
            echo "Invalid 'tariff_year': '${{ inputs.tariff_year }}' (expected 4 digits like 2025)"
            exit 1
          fi

          TARIFF_PATH="data/tariffs/${{ inputs.tariff_name }}/${{ inputs.tariff_year }}.json"
          echo "TARIFF_PATH=${TARIFF_PATH}" >> "$GITHUB_ENV"
          echo "Tariff file path: ${TARIFF_PATH}"

          if [[ ! -f "${TARIFF_PATH}" ]]; then
            echo "Tariff file not found: ${TARIFF_PATH}"
            exit 1
          fi
          jq -e . "${TARIFF_PATH}" >/dev/null

      # 2) Download schema & AJV check
      - name: Download tariff schema (${{ inputs.tariff_schema_version }})
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL \
            "https://raw.githubusercontent.com/Strompreise-Schweiz/supplier-data-validation/main/tariffs/static/${{ inputs.tariff_schema_version }}/tariff.schema.json" \
            -o _tariff.schema.json

      - name: Validate tariff.json with AJV (draft 2020-12, strict, $data)
        shell: bash
        run: |
          set -euo pipefail
          ajv validate \
            -c ajv-formats \
            -s _tariff.schema.json \
            -d "${TARIFF_PATH}" \
            --spec=draft2020 \
            --strict=true \
            --data

